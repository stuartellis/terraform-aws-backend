# terraform-aws-backend

AWS backend for Terraform with Ansible and CloudFormation.

These playbooks deploy a set of replicated S3 buckets and a DynamoDB table. All storage is encrypted with KMS customer-managed keys.

## Setting Up Ansible

Ansible requires Python 3. You may run Ansible on Linux, macOS or WSL.

Run these commands to install Ansible:

    pip3 --user pipx
    pipx install ansible-core
    pipx inject ansible-core boto3

Install the extra Ansible collection for AWS:

    ansible-galaxy collection install amazon.aws

## Usage

To run the Ansible playbook for Terraform execution role:

    ansible-playbook --connection=local ./ansible/deploy-tf-exec-role.yml --extra-vars "managing_account_id=MANAGING-AWS-ACCOUNT-ID org_prefix=YOUR-DOMAIN-NAME stack_prefix=tf-exec"

To run the Ansible playbook for Terraform storage:

    ansible-playbook --connection=local ./ansible/deploy-tf-storage-playbook.yml --extra-vars "org_prefix=YOUR-DOMAIN-NAME stack_prefix=tf-state primary_region=eu-west-2 replica_region_001=eu-west-1 replica_region_002=eu-central-1"

> This example uses eu-west-2 as the AWS region for the main bucket, with replica buckets in eu-west-1 and eu-central-1.

To run the Ansible playbook to deploy Terraform access for CI automation, first get the ARNs of the resources that were generated by the previous playbook.

    ansible-playbook --connection=local ./ansible/deploy-tf-access-svc-identity.yml --extra-vars "org_prefix=YOUR-DOMAIN-NAME stack_prefix=tf-access-svc managing_account_id=MANAGING-AWS-ACCOUNT-ID kms_key_arn=PRIMARY_KMS_KEY_ARN s3_bucket_arn=arn:aws:s3:::YOUR-DOMAIN-NAME-tf-state-primary-MANAGING-AWS-ACCOUNT-ID-eu-west-2 ddb_table_arn=arn:aws:dynamodb:eu-west-2:MANAGING-AWS-ACCOUNT-ID:table/YOUR-DOMAIN-NAME-tf-state-lock-eu-west-2 same_account_exec_role=arn:aws:iam::MANAGING-AWS-ACCOUNT-ID:role/YOUR-DOMAIN-NAME-tf-exec-role account_0001_exec_role=arn:aws:iam::A-MANAGED-AWS-ACCOUNT-ID:role/infra-tf-exec"
