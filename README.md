# terraform-aws-backend

Tooling to deploy an [AWS backend for Terraform state](https://www.terraform.io/language/settings/backends/s3), using [Ansible](https://www.ansible.com/) and CloudFormation.

The aim of this tooling is to set up the AWS resources that Terraform itself needs in a way that does not depend on Terraform.

These templates deploy a set of replicated S3 buckets and a DynamoDB table. Each bucket has [object versioning](https://docs.aws.amazon.com/AmazonS3/latest/userguide/Versioning.html) enabled, so that previous versions of the state files can be restored. All storage is encrypted with KMS customer-managed keys.

To increase the safety of the Terraform state, the policy on the main S3 bucket prevents objects from being deleted.

Ansible provides a convenient way to deploy sets of CloudFormation templates together. You may use the CloudFormation templates without Ansible.

## Design

This assumes that you have two AWS accounts:

- A *managing* AWS account that will contain the Terraform backend
- A *managed* AWS account that will contain resources that will be managed by Terraform

This is good practice. AWS accounts are free, because you are only charged for the resources that you use.

You can use Terraform to control resources in the managing AWS account. The aim of this tooling is to set up the AWS resources that Terraform itself needs. These resources include an IAM user account. This account can assume the roles to access the Terraform storage, and execute Terraform on each AWS account. Your  automation can then use this account to run Terraform on AWS.

These templates can be adapted to support larger numbers of AWS accounts.

The *org_prefix* should be a short string that uniquely identifies the current organization. S3 bucket names must be globally unique across all AWS customers, so we must prefix the name of each bucket with a string that is unique to our accounts. We also use the *org_prefix* to namespace AWS tags.

## Setting Up Ansible

Ansible requires Python 3. You may run Ansible on Linux, macOS or WSL.

Run these commands to install Ansible:

    pip3 --user pipx
    pipx install ansible-core
    pipx inject ansible-core boto3

Install the extra Ansible collection for AWS:

    ansible-galaxy collection install amazon.aws

## Usage

First decide an *org_prefix*, a short string that uniquely identifies your organization. This is used to ensure consistent and unique naming.

Next, create the IAM role that Terraform will use to run on each AWS account.

To run the Ansible playbook for Terraform execution role on an AWS account:

    ansible-playbook --connection=local ./ansible/deploy-tf-exec-role.yml --extra-vars "managing_account_id=MANAGING-AWS-ACCOUNT-ID org_prefix=YOUR-DOMAIN-NAME stack_prefix=tf-exec"

To run the Ansible playbook for Terraform storage:

    ansible-playbook --connection=local ./ansible/deploy-tf-storage-playbook.yml --extra-vars "org_prefix=YOUR-DOMAIN-NAME stack_prefix=tf-state primary_region=eu-west-2 replica_region_001=eu-west-1 replica_region_002=eu-central-1"

> This example uses eu-west-2 as the AWS region for the main bucket, with replica buckets in eu-west-1 and eu-central-1.

To run the Ansible playbook to deploy Terraform access for CI automation, first get the ARNs of the resources that were generated by the previous playbook.

    ansible-playbook --connection=local ./ansible/deploy-tf-access-svc-identity.yml --extra-vars "org_prefix=YOUR-DOMAIN-NAME stack_prefix=tf-access-svc managing_account_id=MANAGING-AWS-ACCOUNT-ID kms_key_arn=PRIMARY_KMS_KEY_ARN s3_bucket_arn=arn:aws:s3:::YOUR-DOMAIN-NAME-tf-state-primary-MANAGING-AWS-ACCOUNT-ID-eu-west-2 ddb_table_arn=arn:aws:dynamodb:eu-west-2:MANAGING-AWS-ACCOUNT-ID:table/YOUR-DOMAIN-NAME-tf-state-lock-eu-west-2 same_account_exec_role=arn:aws:iam::MANAGING-AWS-ACCOUNT-ID:role/YOUR-DOMAIN-NAME-tf-exec-role account_0001_exec_role=arn:aws:iam::A-MANAGED-AWS-ACCOUNT-ID:role/YOUR-DOMAIN-NAME-tf-exec-role"

Once this playbook has completed, you will have a new IAM user account. This account can assume the roles to access the Terraform storage, and execute Terraform on each AWS account. To use the IAM user, create an AWS access key.

## Resources

- [CloudFormation for a Terraform backend, by Tibor Hercz](https://github.com/tiborhercz/tf-state-backend-s3-cloudformation) - An existing implementation, using just CloudFormation
- [Managing Terraform Remote State with CloudFormation, by Chris Kent](https://thirstydeveloper.io/tf-skeleton/2021/02/25/part-6-protecting-state.html) - Part of a series on setting up Terraform
